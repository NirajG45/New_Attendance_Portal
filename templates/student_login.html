<!-- student_login.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Login</title>
</head>
<body>
    <div>
        <h1>Student Login</h1>
        <form id="student-login-form">
            <label for="student_id">Student ID:</label>
            <input type="text" id="student_id" name="student_id" required><br><br>

            <label for="student_password">Password:</label>
            <input type="password" id="student_password" name="student_password" required><br><br>

            <label for="teacher_code">Teacher Attendance Code:</label>
            <input type="text" id="teacher_code" name="teacher_code" required><br><br>

            <button type="submit" id="login-button">Login</button>
        </form>
        <p id="login-message"></p>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const loginForm = document.getElementById("student-login-form");
            const loginMessage = document.getElementById("login-message");
            const loginButton = document.getElementById("login-button");

            loginForm.addEventListener("submit", async function (event) {
                event.preventDefault(); // Prevent default form submission

                const studentId = document.getElementById("student_id").value.trim();
                const studentPassword = document.getElementById("student_password").value.trim();
                const teacherCode = document.getElementById("teacher_code").value.trim();

                if (!studentId || !studentPassword || !teacherCode) {
                    loginMessage.textContent = "All fields are required!";
                    loginMessage.style.color = "red";
                    return;
                }

                // Disable the button and show logging in text
                loginButton.disabled = true;
                loginButton.textContent = "Logging in...";

                // Get student's current location using Geolocation API
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async function (position) {
                        var studentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };

                        const loginData = {
                            student_id: studentId,
                            student_password: studentPassword,
                            teacher_code: teacherCode,
                            location: studentLocation // Send the location with login data
                        };

                        try {
                            const response = await fetch('/student_login', {
                                method: 'POST',
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(loginData),
                            });

                            const responseData = await response.json();

                            if (!response.ok || !responseData.success) {
                                throw new Error(responseData.message || "Login failed.");
                            }

                            // âœ… Redirect to /timer after successful login
                            loginMessage.textContent = "Login successful! Redirecting to timer...";
                            loginMessage.style.color = "green";

                            setTimeout(() => {
                                window.location.href = responseData.redirect_url || "/timer";
                            }, 2000);

                        } catch (error) {
                            console.error("Error:", error);
                            loginMessage.textContent = "Error: " + error.message;
                            loginMessage.style.color = "red";
                        } finally {
                            loginButton.disabled = false;
                            loginButton.textContent = "Login";
                        }
                    });
                } else {
                    loginMessage.textContent = "Geolocation is not supported by this browser.";
                    loginMessage.style.color = "red";
                    loginButton.disabled = false;
                    loginButton.textContent = "Login";
                }
            });
        });
    </script>
</body>
</html>
